{% extends 'base.html' %}

{% block content %}
<div class="container my-5">
    <form method="POST" action="{% url 'place_order' %}">
        {% csrf_token %}
        <h1>Order Summary</h1>

        {% if messages %}
        <ul class="messages">
            {% for message in messages %}
                {% if message.level == 40 %}
                <li class="alert alert-danger">{{ message }}</li>
                {% elif message.level == 25 %}
                <li class="alert alert-success">{{ message }}</li>
                {% else %}
                <li class="alert alert-info">{{ message }}</li>
                {% endif %}
            {% endfor %}
        </ul>
        {% endif %}

        <!-- Order Details -->
        <div class="card mb-3">
            <div class="card-body">
                <h5 class="card-title">Cart Items</h5>
                <ul class="list-group">
                    {% for item in cart_items %}
                    <li class="list-group-item d-flex justify-content-between">
                        <span>{{ item.product.title }}</span>
                        <span>{{ item.quantity }} x ₹{{ item.product.price }}</span>
                    </li>
                    {% endfor %}
                </ul>
                <hr>
                <div class="d-flex justify-content-between">
                    <strong>Total:</strong>
                    <strong>₹{{ total }}</strong>
                </div>
            </div>
        </div>

        <!-- Shipping Address -->
        <h5>Shipping Address</h5>
        <div class="card mb-3">
          <div class="card-body">
            
            {% for address in addresses %}
            <div class="form-check">
                <input class="form-check-input" type="radio" name="shipping_address" value="{{ address.id }}" id="address_{{ address.id }}">
                <label class="form-check-label" for="address_{{ address.id }}">
                    {{ address.flat_building }}, {{ address.area}}, {{ address.landmark}} , {{ address.city }}, {{ address.state}} {{ address.pincode }}
                </label>
                &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                <!-- Edit Address Button -->
                <button type="button" class="btn btn-secondary btn-sm" data-bs-toggle="modal" data-bs-target="#editAddressModal" data-address-id="{{ address.id }}" data-flat-building="{{ address.flat_building }}" data-area="{{ address.area }}" data-landmark="{{ address.landmark }}" data-city="{{ address.city }}"  data-pincode="{{ address.pincode }}">
                    Edit Address
                </button>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                
                
                <!-- Remove Address Button -->
                <button type="button" class="btn btn-danger btn-sm" data-address-id="{{ address.id }}" onclick="removeAddress(this)">
                    Remove Address
                </button>
            </div>
            {% empty %}
            <p>No addresses found. Please add one.</p>
            {% endfor %}

            <!-- Option to add a new address -->
            <a href="{% url 'checkout' %}" class="btn btn-info">Add New Address</a>
        </div>
      </div>

        <!-- Payment Methods -->
        <!-- Payment Methods -->
<div class="mb-3">
    <h5>Choose Payment Method</h5>
    <div class="form-check">
        <input class="form-check-input" type="radio" name="paymentMethod" id="creditCard" value="creditCard" checked>
        <label class="form-check-label" for="creditCard">Credit Card</label>
    </div>
    <div class="form-check">
        <input class="form-check-input" type="radio" name="paymentMethod" id="paypal" value="paypal">
        <label class="form-check-label" for="paypal">PayPal</label>
    </div>
    <div class="form-check">
        <input class="form-check-input" type="radio" name="paymentMethod" id="bankTransfer" value="bankTransfer">
        <label class="form-check-label" for="bankTransfer">Bank Transfer</label>
    </div>

    <!-- Cash on Delivery Option with UPI details -->
    <div class="form-check">
        <input class="form-check-input" type="radio" name="paymentMethod" id="cashOnDelivery" value="cashOnDelivery">
        <label class="form-check-label" for="cashOnDelivery">
            Cash on Delivery (COD)
        </label>
    </div>
    
</div>


        <button class="btn btn-primary" id="submitOrderBtn">Place Order</button>

        <!-- Order Success Message -->
        <div id="orderSuccess" class="alert alert-success mt-3" style="display: none;">
            <strong>Success!</strong> Your order has been placed successfully.
        </div>
    </form>

    <!-- Edit Address Modal -->
    <div class="modal fade" id="editAddressModal" tabindex="-1" aria-labelledby="editAddressModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editAddressModalLabel">Edit Shipping Address</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="editAddressForm">
                        <div class="mb-3">
                            <label for="flat_building" class="form-label">Flat/Building</label>
                            <input type="text" class="form-control" id="flat_building" required>
                        </div>
                        <div class="mb-3">
                            <label for="area" class="form-label">Area</label>
                            <input type="text" class="form-control" id="area" required>
                        </div>
                        <div class="mb-3">
                            <label for="landmark" class="form-label">Landmark</label>
                            <input type="text" class="form-control" id="landmark" required>
                        </div>
                        <div class="mb-3">
                            <label for="city" class="form-label">City</label>
                            <input type="text" class="form-control" id="city" required>
                        </div>
                       
                        <div class="mb-3">
                            <label for="pincode" class="form-label">Pincode</label>
                            <input type="text" class="form-control" id="pincode" required>
                        </div>
                        <button type="submit" class="btn btn-primary">Save Changes</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js" integrity="sha384-oBqDVmMz4fnFO9gybBtp5ZBdyWqB5cIuVZCxXwqdfgA1se3XqfJXrxpHu8u8mHm4" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.min.js" integrity="sha384-pzjw8f+ua7Kw1TIq0d0zV/2QeqmT9T2ry9kUeRaxI5PpxjzI5fkmU6A5F5cV5d/F" crossorigin="anonymous"></script>

    <script>
        // Show address data in the modal
        var editAddressModal = document.getElementById('editAddressModal');
        editAddressModal.addEventListener('show.bs.modal', function(event) {
            var button = event.relatedTarget;
            var addressId = button.getAttribute('data-address-id');
            var flatBuilding = button.getAttribute('data-flat-building');
            var area=button.getAttribute('data-area');
            var landmark=button.getAttribute('data-landmark');
            var city = button.getAttribute('data-city');
          
            var pincode = button.getAttribute('data-pincode');


            console.log('address iddddddddddddddddddddddddddddddddddddd',addressId)
            var modalFlatBuilding = editAddressModal.querySelector('#flat_building');
            var modalArea=editAddressModal.querySelector('#area');
            var modalLandmark=editAddressModal.querySelector('#landmark');
            var modalCity = editAddressModal.querySelector('#city');
          
            var modalPincode = editAddressModal.querySelector('#pincode');

            modalFlatBuilding.value = flatBuilding;
            modalArea.value=area;
            modalLandmark.value=landmark;
            modalCity.value = city;
        
            modalPincode.value = pincode;

            // Handle form submission to update address
            var form = document.getElementById('editAddressForm');
            form.onsubmit = function(e) {
                e.preventDefault();
                
                // Prepare updated address data
                var updatedAddress = {
                    id: addressId,
                    flat_building: modalFlatBuilding.value,
                    area:modalArea.value,
                    landmark:modalArea.value,
                    city: modalCity.value,
                    pincode: modalPincode.value
                };

                // Send the updated address to backend for saving
                fetch('/api/update_address', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                    },
                    body: JSON.stringify(updatedAddress)
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Close the modal and show success message
                        alert('Address updated successfully');
                        location.reload(); // Reload the page to reflect changes
                    } else {
                        alert('Failed to update the address');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('An error occurred while updating the address.');
                });
            };
        });

        // Remove Address Function
        function removeAddress(button) {
    var addressId = button.getAttribute('data-address-id');
    
    // Log the addressId to the console for debugging
    console.log('Address ID:', addressId);

    if (addressId === null || addressId === undefined) {
        alert('Error: Address ID is null or undefined');
        return;
    }

    // Confirm the action
    if (confirm('Are you sure you want to remove this address?')) {
        fetch(`/api/remove_address/${addressId}/`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Remove the address from the page
                alert('Address removed successfully');
                location.reload(); // Reload the page to reflect changes
            } else {
                alert('Failed to remove the address');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while removing the address.');
        });
    }
}



    </script>
</div>
{% endblock %}
